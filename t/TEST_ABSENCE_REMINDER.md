# Инструкция по тестированию функции напоминаний об отсутствиях

## Описание функции

Функция автоматически проверяет всех учеников и находит тех, у кого последние 2 отметки посещаемости - "Отсутствовал". Затем отправляет уведомления менеджерам и владельцу с просьбой связаться с родителями.

## Способы тестирования

### 1. Тест поиска учеников (без отправки сообщений)

Проверяет, правильно ли функция находит учеников с двумя последними отсутствиями:

```bash
python t/test_absence_reminder.py
```

**Что проверяется:**
- Находит ли функция учеников с двумя последними отсутствиями
- Правильно ли парсятся даты
- Нет ли дубликатов учеников в списке
- Корректность группировки по городам

**Вывод:**
- Список найденных учеников
- Информация о последних 2 датах отсутствия
- Проверка на дубликаты

---

### 2. Тест парсинга дат

Проверяет корректность парсинга дат из attendance.json:

```bash
python t/test_parse_date.py
```

**Что проверяется:**
- Парсинг различных форматов дат
- Обработка пробелов
- Обработка невалидных дат

---

### 3. Полный тест с отправкой уведомлений

**⚠️ ВНИМАНИЕ: Этот тест отправит реальные сообщения менеджерам!**

```bash
python t/test_send_absence_reminder.py
```

**Что происходит:**
1. Проверяет наличие учеников с двумя отсутствиями
2. Показывает список найденных учеников
3. Запрашивает подтверждение
4. Отправляет уведомления всем менеджерам и владельцу

**Рекомендации:**
- Используйте этот тест только когда бот запущен
- Убедитесь, что у вас есть тестовые данные в attendance.json
- Проверьте, что в roles.json есть менеджеры для получения уведомлений

---

## Автоматическое тестирование в реальном времени

Функция автоматически запускается каждый день в **13:00** (вместе с напоминаниями о платежах).

### Как проверить автоматическую работу:

1. **Дождаться 13:00** - функция запустится автоматически

2. **Или временно изменить время проверки** в `bot/services/reminder_service.py`:
   ```python
   # Временно изменить время для теста
   PAYMENT_REMINDER_TIME = time(13, 0)  # Измените на текущее время + 1 минута
   ```

3. **Или создать тестовую команду** для ручного запуска (см. ниже)

---

## Создание тестовой команды в боте

Можно добавить команду для владельца, чтобы вручную запускать проверку:

### Вариант 1: Добавить команду в существующий обработчик

Создайте файл `bot/handlers/test_absence.py`:

```python
from aiogram import Router
from aiogram.filters import Command
from aiogram.types import Message
from bot.handlers.reminder_handler import ReminderHandler
from bot.config import OWNER_ID

router = Router()

@router.message(Command("test_absence"))
async def test_absence_command(message: Message, bot):
    """Команда для тестирования напоминаний об отсутствиях (только для владельца)"""
    if message.from_user.id != OWNER_ID:
        await message.answer("❌ Эта команда доступна только владельцу")
        return
    
    reminder_handler = ReminderHandler(bot)
    
    # Очищаем set, чтобы можно было отправить сейчас
    reminder_handler.sent_absence_reminders.clear()
    
    # Отправляем уведомления
    await reminder_handler.send_absence_reminder()
    
    await message.answer("✅ Тестовая отправка выполнена")
```

Затем добавьте в `bot/main.py`:
```python
from bot.handlers import test_absence
dp.include_router(test_absence.router)
```

Теперь можно использовать команду `/test_absence` в боте.

---

## Проверка данных

### Проверка структуры attendance.json

Убедитесь, что файлы `data/{city}/attendance.json` имеют правильную структуру:

```json
{
  "group_id": {
    "group_name": "Название группы",
    "fields": ["№", "ФИО", "25.11.2025", "24.11.2025", ...],
    "attendance": [
      {
        "student_id": "...",
        "ФИО": "Иванов Иван",
        "attendance": {
          "25.11.2025": "Отсутствовал",
          "24.11.2025": "Отсутствовал",
          ...
        }
      }
    ]
  }
}
```

### Проверка roles.json

Убедитесь, что есть менеджеры в `roles.json`:

```json
{
  "user_id": {
    "role": "manager",
    "fio": "Имя менеджера",
    ...
  }
}
```

---

## Ожидаемое поведение

1. **Функция находит учеников** с двумя последними отметками "Отсутствовал"
2. **Исключает "Отсутствовал по причине"** - это не считается как отсутствие
3. **Каждый ученик появляется только один раз** в списке (даже если он в нескольких группах)
4. **Уведомления отправляются** всем менеджерам и владельцу
5. **Сообщения закрепляются** в чате
6. **Уведомления отправляются только один раз в день** (в 13:00)

---

## Устранение проблем

### Проблема: Не находит учеников

**Возможные причины:**
- В attendance.json нет данных
- Даты не в формате "дд.мм.гггг"
- У учеников нет двух последних отметок "Отсутствовал"
- Проблемы с парсингом дат

**Решение:**
- Запустите `test_parse_date.py` для проверки парсинга
- Проверьте структуру attendance.json
- Убедитесь, что есть ученики с двумя последними отсутствиями

### Проблема: Дубликаты учеников

**Решение:**
- Функция уже предотвращает дубликаты через `seen_student_ids`
- Если видите дубликаты, проверьте, что student_id уникален

### Проблема: Уведомления не отправляются

**Возможные причины:**
- Бот не запущен
- Нет менеджеров в roles.json
- Уже отправлено сегодня (проверьте `sent_absence_reminders`)

**Решение:**
- Запустите бота
- Проверьте roles.json
- Используйте тестовый скрипт для ручной отправки

---

## Примеры использования

### Пример 1: Быстрая проверка без отправки

```bash
python t/test_absence_reminder.py
```

### Пример 2: Полный тест с отправкой

```bash
python t/test_send_absence_reminder.py
# Введите "да" когда спросит
```

### Пример 3: Проверка парсинга дат

```bash
python t/test_parse_date.py
```

---

## Дополнительная информация

- Функция работает с данными из `data/{city}/attendance.json`
- Проверка выполняется каждый день в 13:00
- Уведомления отправляются только если есть ученики с двумя отсутствиями
- Сообщения форматируются с группировкой по городам
