# Отчет по оплатам - Инструкция

## Как использовать

Теперь вы можете запрашивать отчеты по оплатам прямо в чате VK бота!

### Формат команды

```
отчет по оплатам <город> <месяц>
```

### Примеры использования

1. **Отчет по конкретному городу за конкретный месяц:**
   ```
   отчет по оплатам Назрань ноябрь
   ```

2. **Отчет по всем городам за конкретный месяц:**
   ```
   отчет по оплатам все ноябрь
   ```

3. **Отчет за текущий месяц (месяц не указывается):**
   ```
   отчет по оплатам Назрань
   ```

### Доступные месяцы

- январь
- февраль
- март
- апрель
- май
- июнь
- июль
- август
- сентябрь
- октябрь
- ноябрь
- декабрь

### Что показывает отчет

Отчет включает в себя:

1. **Город и месяц** - для какого города и месяца сформирован отчет
2. **Общая статистика:**
   - Всего учеников
   - Оплатили
   - Не оплатили

3. **Список не оплативших** с указанием:
   - ФИО ученика
   - Номер телефона родителя
   - Причина (нет записи или статус оплаты)
   - Ссылка на Notion

4. **Список записей в оплатах без соответствующих учеников** (если есть)

### Права доступа

- **Владельцы (owner):** Могут запрашивать отчеты по любому городу
- **Учителя (teacher):** Могут запрашивать отчеты только по своему городу

## Технические детали

### Файлы

- `vk_bot/handlers/payment_report.py` - обработчик команд отчетов
- `vk_bot/services/payment_report_service.py` - логика формирования отчетов

### Как это работает

1. Бот получает сообщение от пользователя
2. Проверяет, что сообщение начинается с "отчет по оплатам"
3. Парсит город и месяц из сообщения
4. Проверяет права доступа пользователя
5. Вызывает `generate_report()` для формирования отчета
6. Отправляет отчет пользователю (если отчет большой, разбивает на части)

### Логика формирования отчета

Для каждого ученика в базе проверяется:

1. **Есть ли запись в payments.json?**
   - Нет → попадает в список "Не оплатили" с причиной "Нет записи в таблице оплат"
   
2. **Если запись есть, какой статус для указанного месяца?**
   - Статус = "Оплатил" → ученик оплатил
   - Статус ≠ "Оплатил" или пустой → попадает в список "Не оплатили" с указанием статуса
